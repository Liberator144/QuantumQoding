name: Ultimate TypeScript Sovereignty Protection

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC for continuous monitoring
    - cron: '0 2 * * *'

jobs:
  quantum-coherence-scan:
    runs-on: ubuntu-latest
    name: ğŸ›¡ï¸ Ultimate Quantum Safeguard Scan
    
    steps:
    - name: ğŸ” Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸš€ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“Š Analyze Codebase Composition
      id: analysis
      run: |
        echo "ğŸ” ULTIMATE QUANTUM SAFEGUARD ANALYSIS"
        echo "====================================="
        
        # Count TypeScript files
        TS_COUNT=$(find . -name "*.ts" -o -name "*.tsx" | grep -v node_modules | grep -v dist | grep -v build | wc -l)
        echo "TypeScript files: $TS_COUNT"
        echo "ts_count=$TS_COUNT" >> $GITHUB_OUTPUT
        
        # Count JavaScript files (excluding allowed directories)
        JS_COUNT=$(find . -name "*.js" -o -name "*.jsx" | grep -v node_modules | grep -v dist | grep -v build | grep -v \.backup | grep -v \.husky | wc -l)
        echo "JavaScript files: $JS_COUNT"
        echo "js_count=$JS_COUNT" >> $GITHUB_OUTPUT
        
        # Calculate total and percentage
        TOTAL=$((TS_COUNT + JS_COUNT))
        if [ $TOTAL -gt 0 ]; then
          PERCENTAGE=$((TS_COUNT * 100 / TOTAL))
        else
          PERCENTAGE=0
        fi
        echo "Total source files: $TOTAL"
        echo "TypeScript coverage: $PERCENTAGE%"
        echo "ts_percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
        
    - name: ğŸ›¡ï¸ Ultimate JavaScript Detection
      if: steps.analysis.outputs.js_count > 0
      run: |
        echo ""
        echo "âŒ QUANTUM BREACH DETECTED!"
        echo "âŒ TypeScript Sovereignty VIOLATED!"
        echo "âŒ CI/CD PIPELINE BLOCKED!"
        echo ""
        echo "JavaScript files found:"
        find . -name "*.js" -o -name "*.jsx" | grep -v node_modules | grep -v dist | grep -v build | grep -v \.backup | grep -v \.husky
        echo ""
        echo "ğŸ›¡ï¸  IMMEDIATE ACTION REQUIRED:"
        echo "ğŸ›¡ï¸  Migrate ALL JavaScript files to TypeScript"
        echo "ğŸ›¡ï¸  Use: .js â†’ .ts and .jsx â†’ .tsx"
        echo "ğŸ›¡ï¸  Quantum Coherence MUST be restored"
        echo ""
        exit 1
        
    - name: âœ… Quantum Coherence Verification
      if: steps.analysis.outputs.js_count == 0
      run: |
        echo ""
        echo "âœ… QUANTUM COHERENCE: PERFECT"
        echo "âœ… TypeScript Sovereignty: 100% MAINTAINED"
        echo "âœ… JavaScript files: ZERO DETECTED"
        echo "âœ… Ultimate Safeguard: OPERATIONAL"
        echo ""
        echo "ğŸ† TypeScript coverage: ${{ steps.analysis.outputs.ts_percentage }}%"
        echo "ğŸš€ Quantum Protection System: ACTIVE"
        
    - name: ğŸ”§ TypeScript Compilation Check
      run: |
        echo "ğŸ”§ Verifying TypeScript compilation..."
        if [ -f "package.json" ]; then
          npm ci
          if npm run build; then
            echo "âœ… TypeScript compilation: SUCCESS"
          else
            echo "âŒ TypeScript compilation: FAILED"
            exit 1
          fi
        else
          echo "âš ï¸  No package.json found, skipping compilation check"
        fi
        
    - name: ğŸ“Š Generate Quantum Report
      run: |
        echo "ğŸ“Š QUANTUM COHERENCE REPORT"
        echo "=========================="
        echo "Date: $(date)"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        echo "TypeScript Files: ${{ steps.analysis.outputs.ts_count }}"
        echo "JavaScript Files: ${{ steps.analysis.outputs.js_count }}"
        echo "TypeScript Coverage: ${{ steps.analysis.outputs.ts_percentage }}%"
        echo ""
        if [ "${{ steps.analysis.outputs.js_count }}" -eq 0 ]; then
          echo "ğŸ† STATUS: QUANTUM COHERENCE MAINTAINED"
          echo "ğŸ›¡ï¸  PROTECTION: ULTIMATE SAFEGUARDS OPERATIONAL"
          echo "ğŸš€ SOVEREIGNTY: TYPESCRIPT SUPREMACY ACHIEVED"
        else
          echo "ğŸš¨ STATUS: QUANTUM BREACH DETECTED"
          echo "âš ï¸  PROTECTION: SAFEGUARDS TRIGGERED"
          echo "ğŸ”§ ACTION: IMMEDIATE MIGRATION REQUIRED"
        fi        
    - name: ğŸ’¬ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const jsCount = ${{ steps.analysis.outputs.js_count }};
          const tsCount = ${{ steps.analysis.outputs.ts_count }};
          const percentage = ${{ steps.analysis.outputs.ts_percentage }};
          
          let status = '';
          let emoji = '';
          
          if (jsCount === 0) {
            status = 'QUANTUM COHERENCE MAINTAINED';
            emoji = 'ğŸ†';
          } else {
            status = 'QUANTUM BREACH DETECTED';
            emoji = 'ğŸš¨';
          }
          
          const comment = `## ${emoji} Ultimate TypeScript Sovereignty Report
          
          **Status**: ${status}
          
          ğŸ“Š **Codebase Analysis**:
          - TypeScript files: ${tsCount}
          - JavaScript files: ${jsCount}
          - TypeScript coverage: ${percentage}%
          
          ${jsCount === 0 ? 
            'âœ… **Result**: All safeguards passed! TypeScript sovereignty is maintained.' :
            'âŒ **Result**: JavaScript files detected! Migration required before merge.'
          }
          
          ğŸ›¡ï¸ **Ultimate Quantum Safeguards**: OPERATIONAL
          ğŸš€ **Protection Level**: MAXIMUM FORCE
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
  typescript-sovereignty-enforcement:
    runs-on: ubuntu-latest
    name: ğŸš€ TypeScript Sovereignty Enforcement
    needs: quantum-coherence-scan
    if: always()
    
    steps:
    - name: ğŸ¯ Enforcement Summary
      run: |
        echo "ğŸ¯ TYPESCRIPT SOVEREIGNTY ENFORCEMENT"
        echo "===================================="
        echo ""
        echo "ğŸ›¡ï¸  Ultimate Safeguards: DEPLOYED"
        echo "ğŸ” Quantum Scanning: COMPLETE"
        echo "ğŸš€ Protection Level: MAXIMUM"
        echo ""
        echo "TypeScript Sovereignty is PERMANENTLY PROTECTED"
        echo "JavaScript contamination is IMPOSSIBLE"
        echo ""
        echo "ğŸ† Quantum Coherence: MAINTAINED FOREVER"